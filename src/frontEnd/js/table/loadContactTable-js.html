<script>
  function loadContactTable(updateDataTable = false) {
    async function loadContactDataTable() {
      try {
        showSwal()
        const tableExtraOptions = {
          tableId: 'contact-table',
          // hideColumns: [13, 14, 15, 16]
          targetIndexShowImage: [3, 15],
        }
        const { data } = await googelScriptrun('getContactData')
        const { data: companyData } = await googelScriptrun('getCompanyData')
        const { data: touchPoint } = await googelScriptrun('getTochPointList')
        const { contact } = await googelScriptrun(
          'getHeaderTableName',
          'contact'
        )

        // company name
        processData(
          data,
          companyData,
          contact.sheetColumn.companyId,
          processList,
          contact.sheetColumn.companyTbCompanyName
        )
        // touch point name
        processData(
          data,
          touchPoint,
          contact.sheetColumn.touchPointId,
          processList,
          contact.sheetColumn.touchPointTbTouchPointName
        )

        const columnLenght = data.shift().length - 4
        const res = {}

        if (columnLenght + 2 === contact.headerTableName.length) {
          res.data = data.map((row) => row.slice(0, columnLenght))
          res.headersAll = contact.headerTableName
        } else {
          console.log('header length not equal to data in column length')
        }
        if (!updateDataTable) {
          const table = loadDataTable(res, tableExtraOptions)
        } else {
          let table = $(`#${tableExtraOptions.tableId}`).DataTable()
          table.clear().rows.add(data).draw()
        }
      } catch (error) {
        catchError(error)
      } finally {
        hideSwal('พร้อมใช้งาน')
      }
    }
    loadContactDataTable()
  }

  /**
   * function name: processData
   * Task : ใช้สำหรับการเปลี่ยน id เป็น name เช่่น CS2403001 -> "company name 1" เมื่อมีการ
   *         loadxxxxTable-js.html (เช่น loadContactTable-js.html)
   */

  function processData(data, dataArray, elIndex, callback, columnIndex) {
    const processedData = []
    const dataNoHeader = data.slice(1)

    dataNoHeader.forEach((row, indexData) => {
      const newRow = row.map((el, indexRow) => {
        if (indexRow === elIndex && el !== '') {
          return callback(
            dataNoHeader,
            dataArray,
            el,
            columnIndex,
            indexData,
            elIndex
          )
        } else {
          return el
        }
      })
      processedData.push(newRow)
    })
    return processedData
  }

  function processList(
    dataNoHeader,
    dataArray,
    dataItems,
    columnIndex,
    indexData,
    elIndex
  ) {
    const list = []
    if (typeof dataItems === 'string') {
      dataItems = dataItems.split(', ')
      dataItems.forEach((dataItem) => {
        const matchingItem = dataArray.filter((item) => item[0] === dataItem)
        if (matchingItem) {
          list.push(matchingItem[0][columnIndex])
        }
      })
    }
    dataNoHeader[indexData][elIndex] = list.join(', ')
    return list.join(', ')
  }
</script>
