<script>
  // Add form template
  function appendForm(formName) {
    console.log('append form working')
    let thisTemplate = document.getElementById(`${formName}FormTemplate`)
    if (!thisTemplate) {
      console.error(`Template for ${formName} form not found`)
      return
    }
    // คัดลอก template content และนำมาวางใน DOM
    let copyThisTemplate = thisTemplate.content.cloneNode(true)
    document.querySelector('.modal-body').appendChild(copyThisTemplate)

    const endpoints = {
      getCompanyData: {
        select2Id: 'companyNameSelect2',
        valueIndex: 0,
        textIndex: 4,
      },
      getTochPointList: {
        select2Id: 'touchPointListSelect2',
        valueIndex: 0,
        textIndex: 1,
      },
    }

    console.log('endpoints :', endpoints)

    getData(endpoints)
  }

  async function getData(endpointsSelect2Options) {
    for (const [endpoint, config] of Object.entries(endpointsSelect2Options)) {
      const { data } = await googelScriptrun(endpoint)
      const dataWithoutHeader = data.slice(1)
      getSelect2Opions(
        config.select2Id,
        dataWithoutHeader,
        config.valueIndex,
        config.textIndex,
        'staticBackdrop'
      )
    }
    // const { data } = await googelScriptrun('getCompanyData')
    // const {data : list} = await googelScriptrun('getTochPointList')

    // console.log('list', list)

    // const dataWithoutHeader = data.slice(1)
    // const listWithoutHeader = list.slice(1)

    // getSelect2Opions(
    //   'companyNameSelect2',
    //   dataWithoutHeader,
    //   0,
    //   4,
    //   'staticBackdrop'
    // )

    // getSelect2Opions(
    //   'touchPointListSelect2',
    //   listWithoutHeader,
    //   0,
    //   1,
    //   'staticBackdrop'
    // )
    // const selectedValues = [
    //   '1',
    //   'ggismo.com',
    //   '2',
    //   'ledonsale.com',
    //   '3',
    //   'geniusgismo',
    // ]
    // // กำหนดค่าให้กับ <select> element
    // $('#touchPointListSelect2').val(selectedValues).trigger('change')
  }

  function removeForm(formName) {
    let thisTemplate = document.getElementById(`${formName}Form`)
    thisTemplate.parentNode.removeChild(thisTemplate)
  }

  function submmitForm(formDataObj) {
    event.preventDefault()
    let targetFunction = document.getElementById('targetFunc').value
    let formInput = new FormData(formDataObj)
    // let inputFields = Array.from(formInput.entries()).reduce(
    //   (acc, [key, value]) => {
    //     acc[key] = value
    //     return acc
    //   },
    //   {}
    // )

    // // เพิ่มการเลือก select เข้าไปเพื่อให้สามารถดึงค่า companyName ได้
    // let companyNameSelect = document.getElementById('companyNameSelect2');
    // let companyName = companyNameSelect.options[companyNameSelect.selectedIndex].value;

    // เพิ่มการดึงค่าที่ถูกเลือกจาก Select2 โดยใช้ jQuery
    let companyName = $('#companyNameSelect2').val()
    console.log('company name is : ', companyName)

    // เพิ่มค่า companyName เข้าไปใน Object inputFields
    let inputFields = {
      ...Object.fromEntries(formInput),
      companyName: companyName,
    }
    console.log('input fields with companyName:', inputFields)

    switch (targetFunction) {
      case 'addData':
        console.log('add data')
        sendDataToServer(formDataObj)
          .then(() => {
            $('#staticBackdrop').modal('hide')
            removeForm(inputFields.formType)
            loadContactTable(true)
          })
          .catch((error) => {
            console.log('error', error)
          })
        break

      case 'editData':
        console.log('edit data')
        break
    }
  }

  function sendDataToServer(formDataObj) {
    return new Promise((resolve, reject) => {
      showSwal()
      googelScriptrun('serverFormInput', formDataObj)
        .then((result) => {
          hideSwal('บันทึกข้อมูลสำเร็จ')
          const textareas = formDataObj.querySelectorAll('textarea')
          // รีเซ็ตค่าใน textarea
          textareas.forEach((textarea) => {
            textarea.textContent = '' // รีเซ็ตค่าใน textarea เป็นข้อความว่าง
          })
          formDataObj.reset()
          console.log('Success:', result)
          resolve(result)
        })
        .catch((error) => {
          failSwal('บันทึกข้อมูลไม่สำเร็จ')
          catchError(error)
          reject(error)
        })
    })
  }

  function editData(el) {
    try {
      async function fillDataToInputForUpdate() {
        let rowData = table.row(el.parentNode.parentNode).data()
        const tableId = table.row(el.parentNode.parentNode.parentNode)
          .context[0]['sTableId']
        const formType = tableId.split('-')[0]
        const contactId = rowData[0]
        let { contact } = await googelScriptrun('getHeaderTableName', formType)
        let company = await googelScriptrun(
          'getContactWithCompanyData',
          contactId
        )

        const dataObj = {}
        const regexFile = /File/i
        const fileList = []
        const formModal = new bootstrap.Modal(
          document.getElementById('staticBackdrop')
        )
        formModal.show()
        appendForm(formType)
        setFormFunction('editData', 'แก้ไขข้อมูล')
        const formInput = document.querySelectorAll('.formInput')
        const previewDiv = document.querySelectorAll('.preview')
        const documentId = document.getElementById('docId')
        // คัดแยก data จาก datatable ที่มีข้อมูลเป็น link ของ file เพื่อนำไปแสดง ใน preview
        rowData.forEach((el, index) => {
          dataObj[contact.objKey[index]] = el
          if (startsWithHttps(el)) {
            fileList.push(el)
          }
        })

        // นำ data จาก datatable มาใส่ในช่อง input ภายใน form
        formInput.forEach((el, index) => {
          if (containsParameterKeyword(regexFile, el.name)) {
            previewDiv.forEach((div, index) => {
              if (fileList[index] !== undefined) {
                div.setAttribute('src', fileList[index])
              }
            })
          } else if (el.name === 'docId') {
            documentId.setAttribute('value', dataObj[`${formType}Id`])
          } else if (dataObj[el.name] === undefined) {
            el.value = ''
          } else {
            el.value = dataObj[el.name]
          }
        })
      }
      fillDataToInputForUpdate()
    } catch (error) {
      catchError()
    }
  }

  function containsParameterKeyword(regex, name) {
    return regex.test(name)
  }

  function startsWithHttps(value) {
    return value.startsWith('https://')
  }

  function setFormFunction(functionName, modalTitle) {
    const callFunction = document.getElementById('targetFunc')
    const showModalTitle = document.querySelector('.modal-title')
    callFunction.setAttribute('value', functionName)
    showModalTitle.textContent = modalTitle
  }

  function preview(event) {
    console.log('event : ', event)
  }
</script>
